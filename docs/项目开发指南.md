# 奶狗快跑 - 项目开发指南

## 快速开始

### 环境要求
- Node.js >= 14.0.0
- 微信开发者工具
- TypeScript

### 安装依赖
```bash
npm install
```

### 开发调试
1. 使用微信开发者工具打开项目
2. 配置AppID（需要在小程序后台配置）
3. 配置后端API地址（在 `miniprogram/utils/config.ts` 中）

## 开发规范

### 代码结构
- `pages/` - 页面目录，每个页面包含 `.ts`, `.wxml`, `.wxss`, `.json` 四个文件
- `components/` - 组件目录（待创建）
- `utils/` - 工具函数目录
- `images/` - 图片资源目录

### 命名规范
- 页面文件：小写字母，多个单词用连字符，如 `user-profile`
- 组件文件：大驼峰，如 `UserCard`
- 变量名：小驼峰，如 `userName`
- 常量：大写下划线，如 `API_BASE_URL`

### API调用规范
所有API调用统一使用 `wx.request`，并在 `utils/api.ts` 中封装统一方法：

```typescript
// utils/api.ts
export function request(options: any) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${API_BASE_URL}${options.url}`,
      method: options.method || 'GET',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`,
        'Content-Type': 'application/json',
        ...options.header
      },
      data: options.data,
      success: (res: any) => {
        if (res.statusCode === 200) {
          if (res.data.code === 200) {
            resolve(res.data.data);
          } else {
            // 处理业务错误
            handleError(res.data);
            reject(res.data);
          }
        } else {
          reject(res);
        }
      },
      fail: reject
    });
  });
}
```

## 核心功能开发指南

### 1. 用户认证流程

#### 1.1 微信登录
```typescript
wx.login({
  success: (res) => {
    const code = res.code;
    // 调用后端接口换取token
    request({
      url: '/api/auth/wechat-login',
      method: 'POST',
      data: { code }
    }).then((data: any) => {
      wx.setStorageSync('token', data.token);
      wx.setStorageSync('userId', data.userId);
    });
  }
});
```

#### 1.2 身份认证
- 男生：上传学生证 → OCR识别 → 人脸识别 → 审核通过
- 女生：上传身份证 → OCR识别 → 可选资产证明 → 审核通过

### 2. 问卷填写流程

问卷分为5个步骤：
1. 基础信息（年龄、学历、职业、城市、作息）
2. 兴趣偏好（多选，可排序）
3. 社交需求（多选）
4. 价值观（消费观、边界、沟通方式）
5. 外貌偏好（风格、接受度）

每个步骤保存到本地，最后统一提交。

### 3. 匹配算法调用

```typescript
// 获取匹配候选人
request({
  url: '/api/match/candidates',
  data: {
    page: 1,
    limit: 10,
    city: '北京'
  }
}).then((data: any) => {
  // 显示候选人列表
});

// 表达喜欢
request({
  url: '/api/match/like',
  method: 'POST',
  data: {
    targetUserId: 'xxx',
    action: 'like'
  }
}).then((data: any) => {
  if (data.isMutual) {
    // 双向匹配成功
  }
});
```

### 4. 聊天功能

#### 4.1 发送消息
```typescript
// 先进行内容审核
request({
  url: '/api/chat/audit',
  method: 'POST',
  data: { content: message }
}).then((auditResult: any) => {
  if (auditResult.status === 'passed') {
    // 发送消息
    request({
      url: '/api/chat/send',
      method: 'POST',
      data: {
        matchId: 'xxx',
        content: message,
        type: 'text'
      }
    });
  } else {
    // 提示内容被拦截
  }
});
```

#### 4.2 实时消息（WebSocket）
```typescript
// 建立WebSocket连接
const socket = wx.connectSocket({
  url: 'wss://api.example.com/ws',
  header: {
    'Authorization': `Bearer ${token}`
  }
});

socket.onMessage((res) => {
  // 处理接收到的消息
  const message = JSON.parse(res.data);
  // 更新消息列表
});
```

### 5. 支付功能

#### 5.1 创建订单
```typescript
request({
  url: '/api/payment/create-unlock-order',
  method: 'POST',
  data: {
    matchId: 'xxx',
    type: 'single'
  }
}).then((data: any) => {
  // 发起微信支付
  wx.requestPayment({
    timeStamp: data.paymentParams.timeStamp,
    nonceStr: data.paymentParams.nonceStr,
    package: data.paymentParams.package,
    signType: data.paymentParams.signType,
    paySign: data.paymentParams.paySign,
    success: () => {
      // 支付成功，请求联系方式共享
    }
  });
});
```

## 错误处理

### 统一错误处理
```typescript
function handleError(error: any) {
  const errorCode = error.errorCode;
  const message = error.message;
  
  switch (errorCode) {
    case 'AUTH_REQUIRED':
      // 跳转到登录页
      wx.redirectTo({ url: '/pages/login/login' });
      break;
    case 'PERMISSION_DENIED':
      wx.showToast({ title: '权限不足', icon: 'none' });
      break;
    default:
      wx.showToast({ title: message || '操作失败', icon: 'none' });
  }
}
```

## 测试指南

### 单元测试
```bash
npm run test
```

### 集成测试
在微信开发者工具中测试各个功能流程。

### 测试账号
- 测试环境使用测试AppID
- 支付使用沙箱环境

## 部署指南

### 1. 构建
```bash
npm run build
```

### 2. 上传代码
使用微信开发者工具上传代码版本。

### 3. 提交审核
在小程序后台提交审核。

### 4. 发布
审核通过后发布。

## 常见问题

### Q: 如何调试API接口？
A: 在 `utils/config.ts` 中配置开发环境API地址，使用Charles或Fiddler抓包。

### Q: 支付回调如何处理？
A: 支付回调由后端处理，前端通过轮询订单状态确认支付结果。

### Q: 如何处理敏感信息？
A: 敏感信息（手机号、微信号）使用AES加密存储，仅在解锁后展示。

## 参考资料

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信支付文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [项目API文档](./API接口定义.md)
- [数据库设计文档](./数据库设计.md)
