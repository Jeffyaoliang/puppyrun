# 微信小程序域名配置说明

## 问题说明

如果遇到以下错误提示：
- "工具未校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
- API 请求失败（404、网络错误等）

这是因为微信小程序对网络请求有严格的域名白名单限制。

## 解决方案

### 方法1：开发环境 - 关闭域名校验（推荐用于开发测试）

在微信开发者工具中：

1. 点击右上角 **详情** 按钮
2. 在 **项目设置** 选项卡中
3. 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**
4. 勾选 **"不校验 TLS 版本以及 HTTPS 证书"**

这样在开发环境中就不会校验域名，可以自由访问任何 HTTPS 接口。

⚠️ **注意**：此设置仅适用于开发环境，真机调试和正式版本仍然需要配置合法域名。

### 方法2：生产环境 - 配置合法域名（必须用于正式发布）

#### 步骤1：登录微信小程序后台

访问：https://mp.weixin.qq.com

#### 步骤2：进入开发设置

1. 登录后，点击左侧菜单 **开发** → **开发管理** → **开发设置**
2. 找到 **服务器域名** 部分

#### 步骤3：配置域名

需要配置以下类型的域名：

##### 1. request合法域名（API请求）

添加你的后端 API 域名，例如：
```
https://api.puppyrun.site
```

**要求**：
- 必须是 HTTPS 协议
- 必须是已备案的域名（如果使用国内服务器）
- TLS 版本必须 >= 1.2
- 证书必须有效

##### 2. uploadFile合法域名（文件上传）

如果使用 `wx.uploadFile` 上传文件，需要添加：
```
https://api.puppyrun.site
```

##### 3. downloadFile合法域名（文件下载）

如果使用 `wx.downloadFile` 下载文件，需要添加：
```
https://api.puppyrun.site
```

##### 4. socket合法域名（WebSocket）

如果使用 WebSocket，需要添加：
```
wss://api.puppyrun.site
```

##### 5. web-view（业务域名）

如果使用 `<web-view>` 组件，需要添加业务域名。

**配置要求**：
- 需要下载验证文件并放到服务器根目录
- 文件路径：`https://你的域名/MP_verify_xxxxx.txt`

#### 步骤4：配置说明

每个域名类型最多可以配置 **20个** 域名。

**重要限制**：
- ❌ 不能使用 IP 地址
- ❌ 不能使用 localhost
- ❌ 不能使用端口号（必须使用标准端口 443）
- ✅ 必须使用 HTTPS（WSS for WebSocket）
- ✅ 必须是已备案的域名（国内服务器）

## 当前项目配置

### API 域名

当前配置的 API 域名：`https://api.puppyrun.site`

### 检查域名配置

在 `miniprogram/utils/config.ts` 中查看当前配置：

```typescript
export const API_BASE_URL = 'https://api.puppyrun.site';
```

### 验证域名配置

1. **检查 HTTPS 证书**：
   - 访问 https://api.puppyrun.site
   - 确认浏览器显示绿色锁图标，证书有效

2. **检查 TLS 版本**：
   - 使用 SSL Labs 测试：https://www.ssllabs.com/ssltest/
   - 确保 TLS 版本 >= 1.2

3. **检查域名备案**：
   - 如果使用国内服务器，确保域名已备案
   - 可以在 https://beian.miit.gov.cn/ 查询

## 常见问题

### Q1: 开发工具可以访问，但真机调试失败？

**A**: 真机调试必须配置合法域名。确保：
1. 已在微信小程序后台配置域名
2. 域名使用 HTTPS
3. TLS 版本 >= 1.2
4. 证书有效

### Q2: 为什么上传文件失败？

**A**: 文件上传需要单独配置 `uploadFile合法域名`：
1. 登录微信小程序后台
2. 开发 → 开发管理 → 开发设置
3. 在 **uploadFile合法域名** 中添加域名

### Q3: 可以使用 IP 地址吗？

**A**: ❌ 不可以。微信小程序只支持域名，不支持 IP 地址。

### Q4: 本地开发怎么办？

**A**: 两种方案：
1. **推荐**：使用 Cloudflare Tunnel 等工具将本地服务映射到域名
2. **临时**：在开发工具中勾选"不校验合法域名"（仅开发工具有效）

### Q5: 测试环境域名如何配置？

**A**: 测试域名也需要添加到合法域名列表中。建议：
- 开发环境：`https://dev-api.puppyrun.site`
- 生产环境：`https://api.puppyrun.site`

### Q6: 配置后多久生效？

**A**: 通常立即生效，最多等待 5-10 分钟。

## 参考文档

- [微信小程序网络请求文档](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html)
- [微信小程序文件上传文档](https://developers.weixin.qq.com/miniprogram/dev/api/network/upload/wx.uploadFile.html)
- [微信小程序域名配置文档](https://developers.weixin.qq.com/miniprogram/dev/framework/ability/network.html)

