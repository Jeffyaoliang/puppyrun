# 无域名部署后端方案

## 📋 概述

如果没有域名，可以使用以下方案快速部署后端并获得 HTTPS 地址：

1. **内网穿透工具**（推荐）- 快速获得 HTTPS 地址
2. **免费二级域名** - 临时使用
3. **本地开发 + 代理** - 仅开发环境

---

## 🚀 方案 1：使用内网穿透（推荐）

### 1.0 使用 Cloudflare Tunnel（免费 + 固定域名 ⭐⭐⭐⭐⭐）

**最佳选择！** 免费且提供固定域名，不随重启变化。

#### 步骤 1：注册 Cloudflare 账号

1. 访问：https://dash.cloudflare.com/sign-up
2. 注册账号（免费）

#### 步骤 2：添加域名到 Cloudflare

1. 登录 Cloudflare Dashboard
2. 点击 "Add a Site"
3. 输入一个域名（可以是免费域名，如 .tk, .ml 等）
   - 或者购买一个便宜的域名（.xyz 约 10元/年）
4. 选择免费计划（Free）
5. 按照提示修改 DNS 解析（添加到 Cloudflare）

#### 步骤 3：安装 Cloudflare Tunnel

```bash
# Windows
# 下载：https://github.com/cloudflare/cloudflared/releases
# 下载 cloudflared-windows-amd64.exe，重命名为 cloudflared.exe

# Mac
brew install cloudflared

# Linux
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
chmod +x cloudflared-linux-amd64
sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
```

#### 步骤 4：登录并创建隧道

```bash
# 登录 Cloudflare
cloudflared tunnel login

# 创建隧道
cloudflared tunnel create my-backend

# 会生成一个隧道 ID，记录下来
```

#### 步骤 5：配置隧道

创建配置文件 `~/.cloudflared/config.yml`：

```yaml
tunnel: YOUR_TUNNEL_ID
credentials-file: /Users/yourname/.cloudflared/YOUR_TUNNEL_ID.json

ingress:
  - hostname: api.yourdomain.com  # 你的域名
    service: http://localhost:3000
  - service: http_status:404
```

#### 步骤 6：创建 DNS 记录

```bash
# 创建 DNS CNAME 记录
cloudflared tunnel route dns my-backend api.yourdomain.com
```

#### 步骤 7：启动隧道

```bash
# 启动隧道（会在后台运行）
cloudflared tunnel run my-backend

# 或作为服务运行（推荐）
cloudflared service install
cloudflared service start
```

#### 步骤 8：配置小程序

```typescript
export const API_BASE_URL = 'https://api.yourdomain.com';
```

**优点：**
- ✅ 完全免费
- ✅ 固定域名，不会变化
- ✅ 全球 CDN，速度快
- ✅ 自动 HTTPS
- ✅ 无需公网 IP

**缺点：**
- ⚠️ 需要有一个域名（可以是免费域名）

---

### 1.1 使用 ngrok（最简单，但地址会变）

#### 步骤 1：注册并下载

1. **注册账号**
   - 访问：https://ngrok.com
   - 使用邮箱注册（免费）

2. **下载客户端**
   - Windows: 下载 `ngrok.exe`
   - Mac/Linux: 下载对应版本
   - 或使用包管理器：
     ```bash
     # Windows (Chocolatey)
     choco install ngrok
     
     # Mac (Homebrew)
     brew install ngrok
     ```

#### 步骤 2：获取 authtoken

1. 登录 ngrok 后台：https://dashboard.ngrok.com/get-started/your-authtoken
2. 复制你的 authtoken（类似：`2abc123def456ghi789jkl012mno345pqr678`）

#### 步骤 3：配置 ngrok

```bash
# 配置 authtoken
ngrok config add-authtoken YOUR_AUTHTOKEN

# 启动本地后端（假设运行在 3000 端口）
# 在你的后端项目目录下
npm start  # 或你的启动命令

# 在另一个终端启动 ngrok
ngrok http 3000
```

#### 步骤 4：获得 HTTPS 地址

ngrok 会显示类似这样的信息：

```
Forwarding    https://abc123.ngrok.io -> http://localhost:3000
```

**这就是你的 API 地址！**

#### 步骤 5：配置小程序

打开 `miniprogram/utils/config.ts`：

```typescript
export const API_BASE_URL = 'https://abc123.ngrok.io';
```

**注意：** 免费版每次重启 ngrok 地址会变化，需要重新配置。

#### ngrok 免费版限制

- ✅ 支持 HTTPS
- ✅ 全球可用
- ⚠️ 每次重启地址会变化
- ⚠️ 有连接数限制

**解决方法：** 
- 使用付费版（$8/月）可以获得固定域名
- 或使用 Cloudflare Tunnel（免费，固定域名）

---

### 1.2 使用 natapp（国内，免费）

#### 步骤 1：注册账号

1. 访问：https://natapp.cn
2. 注册账号（免费）

#### 步骤 2：配置隧道

1. 登录后台
2. 点击「购买隧道」->「免费隧道」
3. 选择协议：Web 协议
4. 记录 authtoken

#### 步骤 3：下载客户端

1. 下载对应系统的客户端
2. 解压到本地

#### 步骤 4：启动

```bash
# 配置 authtoken
natapp -authtoken=YOUR_TOKEN

# 启动本地后端
npm start

# 在另一个终端启动 natapp
natapp -authtoken=YOUR_TOKEN
```

#### 步骤 5：获得地址

natapp 会显示类似：
```
https://abc123.natapp1.cc
```

#### 步骤 6：配置小程序

```typescript
export const API_BASE_URL = 'https://abc123.natapp1.cc';
```

---

### 1.3 使用 frp（自建，免费）

如果你有自己的服务器（如 Paratera 云服务器），可以使用 frp：

#### 服务器端（frps）

```bash
# 下载 frp
wget https://github.com/fatedier/frp/releases/download/v0.52.0/frp_0.52.0_linux_amd64.tar.gz
tar -xzf frp_0.52.0_linux_amd64.tar.gz
cd frp_0.52.0_linux_amd64

# 配置 frps.ini
[common]
bind_port = 7000
vhost_http_port = 80
vhost_https_port = 443

# 启动
./frps -c frps.ini
```

#### 客户端（本地）

```bash
# 配置 frpc.ini
[common]
server_addr = your-server-ip
server_port = 7000

[web]
type = http
local_port = 3000
custom_domains = api.yourdomain.com  # 需要先解析域名到服务器
```

---

## 🌐 方案 2：使用免费二级域名

### 2.1 Freenom（免费域名）

1. **注册账号**
   - 访问：https://www.freenom.com
   - 注册账号

2. **注册免费域名**
   - 搜索可用域名（.tk, .ml, .ga 等）
   - 注册免费域名

3. **域名解析**
   - 解析到你的服务器 IP
   - 或解析到内网穿透地址

**注意：** 免费域名可能不被微信小程序认可，建议仅用于测试。

---

## 💻 方案 3：本地开发方案

### 3.1 微信开发者工具代理

如果只是本地开发，可以使用代理：

1. **配置本地后端**
   ```bash
   # 启动后端（运行在 localhost:3000）
   npm start
   ```

2. **配置微信开发者工具**
   - 工具 -> 设置 -> 代理设置
   - 配置代理地址：`http://localhost:3000`

3. **小程序配置**
   ```typescript
   // 开发环境可以使用测试地址
   export const API_BASE_URL = 'https://httpbin.org';  // 仅测试
   ```

**限制：** 只能在开发工具中使用，真机无法访问。

---

## 📝 完整示例：使用 ngrok

### 步骤 1：准备后端代码

确保后端代码正常运行：

```javascript
// server.js
const express = require('express');
const app = express();

app.use(express.json());

app.post('/api/questionnaire/submit', (req, res) => {
  console.log('Received:', req.body);
  res.json({ code: 200, message: '成功', data: {} });
});

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
```

### 步骤 2：启动后端

```bash
npm start
# 应该看到：Server running on http://localhost:3000
```

### 步骤 3：启动 ngrok

```bash
# 配置 authtoken（只需一次）
ngrok config add-authtoken YOUR_AUTHTOKEN

# 启动 ngrok
ngrok http 3000
```

### 步骤 4：获得地址

ngrok 会显示：

```
Session Status                online
Account                       your-email@example.com
Version                       3.x.x
Region                        United States (us)
Latency                       45ms
Web Interface                 http://127.0.0.1:4040
Forwarding                    https://abc123.ngrok.io -> http://localhost:3000
```

**API 地址：** `https://abc123.ngrok.io`

### 步骤 5：配置小程序

```typescript
// miniprogram/utils/config.ts
export const API_BASE_URL = 'https://abc123.ngrok.io';
```

### 步骤 6：测试

1. 在浏览器访问：`https://abc123.ngrok.io/api/test`
2. 在小程序中测试提交问卷
3. 查看 ngrok 控制台：http://127.0.0.1:4040（可以看到所有请求）

---

## ⚠️ 注意事项

### 1. 地址变化问题

**ngrok 免费版：** 每次重启地址会变化

**解决方法：**
- 使用 ngrok 配置文件设置固定域名（需要付费）
- 或每次重启后更新小程序配置

**natapp 免费版：** 地址可能变化

**解决方法：**
- 使用付费版获得固定域名
- 或每次更新配置

### 2. 微信小程序域名校验

开发环境：
- 在微信开发者工具中勾选「不校验合法域名」
- 可以访问任何 HTTPS 地址

真机测试：
- 必须在微信后台配置合法域名
- 免费二级域名可能不被认可
- **建议：** 开发时用内网穿透，上线前购买正式域名

### 3. 性能考虑

内网穿透会经过第三方服务器，可能有延迟：
- ngrok：通常较快（国外服务器）
- natapp：国内访问较快
- 自建 frp：性能最好

---

## 🎯 推荐方案对比

| 方案 | 难度 | 成本 | 地址稳定性 | 适用场景 |
|------|------|------|-----------|----------|
| **Cloudflare Tunnel** | ⭐⭐ | 免费 | ⭐⭐⭐⭐⭐ 固定 | 最佳选择！免费且稳定 |
| **ngrok 付费版** | ⭐ | $8/月 | ⭐⭐⭐⭐⭐ 固定 | 快速简单，需付费 |
| **ngrok 免费版** | ⭐ | 免费 | ⭐ 会变化 | 快速开发测试 |
| **natapp 付费版** | ⭐ | 付费 | ⭐⭐⭐⭐ 固定 | 国内访问较快 |
| **natapp 免费版** | ⭐ | 免费 | ⭐⭐ 可能变化 | 国内访问较快 |
| **frp 自建** | ⭐⭐⭐ | 免费 | ⭐⭐⭐⭐⭐ 固定 | 有服务器，长期使用 |
| **免费域名** | ⭐⭐ | 免费 | ⭐⭐⭐ 固定 | 临时测试 |

---

## 🚀 快速开始

### 方案 A：Cloudflare Tunnel（推荐 - 免费 + 固定域名）

#### 1. 注册 Cloudflare 并添加域名

访问：https://dash.cloudflare.com/sign-up
- 添加一个域名（可以买便宜的 .xyz 域名，约 10元/年）
- 或使用免费域名（.tk, .ml 等，但可能不稳定）

#### 2. 安装 Cloudflare Tunnel

```bash
# Mac
brew install cloudflared

# Windows: 下载并添加到 PATH
# https://github.com/cloudflare/cloudflared/releases
```

#### 3. 创建并启动隧道

```bash
# 登录
cloudflared tunnel login

# 创建隧道
cloudflared tunnel create my-backend

# 配置 DNS（替换为你的域名）
cloudflared tunnel route dns my-backend api.yourdomain.com

# 启动隧道
cloudflared tunnel run my-backend
```

#### 4. 配置小程序

```typescript
export const API_BASE_URL = 'https://api.yourdomain.com';
```

**优点：** 地址固定，免费，全球 CDN！

---

### 方案 B：ngrok（最简单，但地址会变）

#### 1. 注册 ngrok

访问：https://ngrok.com/signup

#### 2. 安装并配置

```bash
# 配置 authtoken
ngrok config add-authtoken YOUR_AUTHTOKEN
```

#### 3. 启动后端和 ngrok

```bash
# 终端 1：启动后端
npm start

# 终端 2：启动 ngrok
ngrok http 3000
```

#### 4. 配置小程序

```typescript
export const API_BASE_URL = 'https://xxxxx.ngrok.io';
```

**注意：** 每次重启地址会变化

---

## 📚 下一步

配置好 HTTPS 地址后：

1. ✅ 在小程序中配置 API 地址
2. ✅ 测试接口是否正常
3. ✅ 开发完成后购买正式域名
4. ✅ 部署到生产服务器

参考文档：
- [快速配置后端API.md](./快速配置后端API.md)
- [如何获取后端API域名.md](./如何获取后端API域名.md)

---

## 🆘 常见问题

### Q1: ngrok 地址每次重启都变化？

**A:** 免费版会变化。解决方法：
- ✅ **最佳方案：** 使用 Cloudflare Tunnel（免费，固定域名）
- 使用 ngrok 付费版（$8/月）获得固定域名
- 或每次重启后更新小程序配置

### Q2: 内网穿透速度慢？

**A:** 
- 选择离你较近的服务器区域
- ngrok 可以选择区域：`ngrok http 3000 --region ap`（亚太）
- 或使用 natapp（国内服务器）

### Q3: 微信小程序不认可这个域名？

**A:** 
- 开发环境：在开发者工具中关闭域名校验
- 真机测试：需要购买正式域名并备案
- 临时方案：只能用于开发，不能上线

### Q4: 可以一直用内网穿透吗？

**A:** 
- 开发阶段：可以
- 生产环境：不建议，建议购买正式域名
- 原因：不稳定、速度慢、可能被封

---

## 💡 建议

**开发阶段：**
- 使用 ngrok 或 natapp 快速获得 HTTPS 地址
- 专注于功能开发

**测试阶段：**
- 继续使用内网穿透
- 或购买便宜的域名（.xyz 约 10元/年）

**生产环境：**
- 购买正式域名（.com/.cn）
- 部署到云服务器
- 配置 SSL 证书

